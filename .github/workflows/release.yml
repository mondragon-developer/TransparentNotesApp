name: Build and Sign Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-sign:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish application
        run: dotnet publish TransparentNotesApp/TransparentNotesApp.csproj -c Release -o publish

      - name: Download Trusted Signing Client
        run: |
          Invoke-WebRequest -Uri "https://www.nuget.org/api/v2/package/Microsoft.Trusted.Signing.Client" -OutFile "$env:TEMP\trustedsigning.zip"
          Expand-Archive -Path "$env:TEMP\trustedsigning.zip" -DestinationPath "$env:TEMP\trustedsigning" -Force

      - name: Create signing metadata
        run: |
          $content = '{"Endpoint":"https://eus.codesigning.azure.net/","CodeSigningAccountName":"mondragon-developer","CertificateProfileName":"securepass-signing"}'
          [System.IO.File]::WriteAllText("$env:TEMP\metadata.json", $content)

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: '{"clientId":"${{ secrets.AZURE_CLIENT_ID }}","clientSecret":"${{ secrets.AZURE_CLIENT_SECRET }}","subscriptionId":"${{ secrets.AZURE_SUBSCRIPTION_ID }}","tenantId":"${{ secrets.AZURE_TENANT_ID }}"}'

      - name: Sign executable
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          $dlib = "$env:TEMP\trustedsigning\bin\x64\Azure.CodeSigning.Dlib.dll"
          $metadata = "$env:TEMP\metadata.json"
          & $signtool sign /v /fd SHA256 /tr "http://timestamp.digicert.com" /td SHA256 /dlib $dlib /dmdf $metadata "publish\TransparentNotesApp.exe"

      - name: Verify signature
        run: |
          $signtool = "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe"
          & $signtool verify /pa "publish\TransparentNotesApp.exe"

      - name: Upload signed artifact
        uses: actions/upload-artifact@v4
        with:
          name: TransparentNotesApp-signed
          path: publish/TransparentNotesApp.exe

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: publish/TransparentNotesApp.exe
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
